name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: https://gitea.huiyim.cn/actions/checkout@v4

      - name: Setup Node.js
        uses: https://gitea.huiyim.cn/actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Compress Artifacts
        run: |
          mv .output output_dist
          tar -czf deploy.tar.gz output_dist docker-compose.yml Dockerfile package.json

      - name: Transfer Files to Server
        uses: https://gitea.huiyim.cn/actions/scp-action@v0.1.7
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          source: "deploy.tar.gz"
          target: "/data/prompt"

      - name: Deploy Service
        uses: https://gitea.huiyim.cn/actions/ssh-action@v1.0.0
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          script: |
            cd /data/prompt

            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # æ¢å¤éšè—ç›®å½•
            rm -rf .output
            mv output_dist .output

            echo "ï¿½ éªŒè¯æ–‡ä»¶ä¼ è¾“:"
            ls -la

            echo "ï¿½ğŸ›‘ åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨ï¼ˆç­‰å¾…30ç§’ï¼‰..."
            docker compose down -t 30 || true

            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
            docker compose up -d --build --remove-orphans --force-recreate

            echo "ğŸš€ å‘å¸ƒå®Œæˆï¼Œç­‰å¾…å®¹å™¨é‡å¯..."
