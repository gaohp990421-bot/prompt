name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: https://gitea.huiyim.cn/actions/checkout@v4

      - name: Setup Node.js
        uses: https://gitea.huiyim.cn/actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Prepare Artifacts
        run: |
          mv .output output_dist
          echo "ğŸ“‚ å‡†å¤‡ä¼ è¾“çš„æ–‡ä»¶:"
          ls -la

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Transfer Files via SSH Pipe
        run: |
          tar -czf - output_dist docker-compose.yml Dockerfile package.json | \
            sshpass -p 'Gaohp@990421' ssh -o StrictHostKeyChecking=no root@202.200.206.157 \
            "mkdir -p /data/prompt && cd /data/prompt && rm -rf output_dist .output && tar -xzf -"

          echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"

      - name: Deploy Service
        uses: https://gitea.huiyim.cn/actions/ssh-action@v1.0.0
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          script: |
            echo "ğŸ”Œ è¿æ¥æˆåŠŸ $(date)"
            cd /data/prompt

            echo "ğŸ“‚ ä¼ è¾“åç›®å½•æ£€æŸ¥:"
            ls -la

            # éªŒè¯ output_dist å­˜åœ¨
            if [ ! -d "output_dist" ]; then
              echo "âŒ é”™è¯¯: output_dist ä¸å­˜åœ¨"
              exit 1
            fi
            echo "âœ… output_dist ç›®å½•å·²å°±ç»ª"

            echo "ğŸ›‘ åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨..."
            docker compose down -t 30 || true

            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
            docker compose up -d --build --remove-orphans --force-recreate

            echo "âœ… å‘å¸ƒå®Œæˆ $(date)"
