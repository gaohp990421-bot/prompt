name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: https://gitea.huiyim.cn/actions/checkout@v4

      - name: Setup Node.js
        uses: https://gitea.huiyim.cn/actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Compress Artifacts
        run: |
          mv .output output_dist
          tar -czf deploy.tar.gz output_dist docker-compose.yml Dockerfile package.json

      - name: Prepare Server Directory
        uses: https://gitea.huiyim.cn/actions/ssh-action@v1.0.0
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          script: |
            echo "ğŸ”§ å‡†å¤‡éƒ¨ç½²ç›®å½•..."
            mkdir -p /data/prompt
            chmod 755 /data/prompt
            # æ¸…ç†æ—§çš„å‹ç¼©åŒ…é˜²æ­¢æ··æ·†
            rm -f /data/prompt/deploy.tar.gz

      - name: Transfer Files to Server
        uses: https://gitea.huiyim.cn/actions/scp-action@v0.1.7
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          source: "deploy.tar.gz"
          target: "/data/prompt"

      - name: Deploy Service
        uses: https://gitea.huiyim.cn/actions/ssh-action@v1.0.0
        with:
          host: "202.200.206.157"
          username: "root"
          password: "Gaohp@990421"
          script: |
            echo "ğŸ”Œ è¿æ¥æˆåŠŸ $(date)"
            cd /data/prompt || mkdir -p /data/prompt && cd /data/prompt

            echo "ğŸ“‚ åˆå§‹ç›®å½•æ£€æŸ¥:"
            ls -la

            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
            if [ -f "deploy.tar.gz" ]; then
              tar -xzf deploy.tar.gz
              rm deploy.tar.gz
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° deploy.tar.gz"
              exit 1
            fi

            # æ¢å¤éšè—ç›®å½•
            rm -rf .output
            if [ -d "output_dist" ]; then
              mv output_dist .output
            else
               echo "âš ï¸ è­¦å‘Š: output_dist ä¸å­˜åœ¨"
            fi

            echo "ğŸ“‚ è§£å‹åéªŒè¯:"
            ls -la

            echo "ğŸ›‘ åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨..."
            docker compose down -t 30 || true

            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
            docker compose up -d --build --remove-orphans --force-recreate

            echo "âœ… å‘å¸ƒå®Œæˆ $(date)"
